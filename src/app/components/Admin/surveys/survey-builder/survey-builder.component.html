<div class="container-fluid py-4">
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-3">Cargando constructor...</p>
  </div>

  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
    <button class="btn btn-sm btn-outline-danger ms-2" (click)="goBack()">Volver</button>
  </div>

  <div *ngIf="!loading && !error && builderState" class="row">
    
    <div class="col-12 mb-4">
      <div class="d-flex justify-content-between align-items-center">
        <div class="flex-grow-1">
          <button class="btn btn-sm btn-outline-secondary me-3" (click)="goBack()">
            <i class="fa-solid fa-arrow-left me-2"></i>
            Volver
          </button>
          <span *ngIf="!editingTitle" class="h3 mb-0" (click)="editingTitle = true" style="cursor: pointer;">
            {{ builderState.title }}
          </span>
          <input 
            *ngIf="editingTitle"
            type="text"
            class="form-control d-inline-block"
            style="width: auto; max-width: 500px;"
            [value]="builderState.title"
            (blur)="saveTitle($any($event.target).value)"
            (keydown.enter)="saveTitle($any($event.target).value)"
            #titleInput
            autofocus
          />
        </div>
        <div class="d-flex align-items-center gap-2">
          <span [ngClass]="surveyStatus === 'draft' ? 'badge bg-warning text-dark' : surveyStatus === 'closed' ? 'badge bg-secondary' : 'badge bg-success'">
            {{ surveyStatus === 'draft' ? 'Borrador' : surveyStatus === 'closed' ? 'Cerrada' : 'Activa' }}
          </span>
          <button 
            *ngIf="surveyStatus === 'draft'"
            class="btn btn-sm btn-success"
            (click)="activateSurvey()"
            title="Activar encuesta"
          >
            <i class="fa-solid fa-play me-1"></i>
            Activar
          </button>
          <button 
            *ngIf="surveyStatus === 'active'"
            class="btn btn-sm btn-secondary"
            (click)="closeSurvey()"
            title="Cerrar encuesta"
          >
            <i class="fa-solid fa-stop me-1"></i>
            Cerrar
          </button>
          <button 
            *ngIf="surveyStatus === 'active'"
            class="btn btn-sm btn-outline-primary"
            (click)="copyPublicLink()"
            title="Copiar link público"
          >
            <i class="fa-solid fa-link me-1"></i>
            Copiar link
          </button>
        </div>
      </div>
    </div>

    
    <div class="col-md-8">
      <h4 class="mb-3">Lienzo</h4>
      <p class="text-muted mb-4">
        Arrastra componentes desde la derecha o haz clic en una pregunta para editarla.
      </p>

      <div class="border border-dashed rounded p-4 min-vh-50" style="min-height: 400px;">
        <div *ngIf="builderState.questions.length === 0" class="text-center py-5 text-muted">
          <p>El lienzo está vacío.</p>
          <p class="small">Arrastra un componente para comenzar.</p>
        </div>

        <div *ngFor="let question of builderState.questions; let i = index" class="mb-3">
          <div *ngIf="editingQuestionId !== question.id" 
               class="card"
               (click)="editingQuestionId = question.id"
               style="cursor: pointer;">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <h6 class="card-title mb-1">{{ question.text }}</h6>
                  <span class="badge bg-secondary">{{ getQuestionTypeLabel(question.type) }}</span>
                </div>
                <button 
                  class="btn btn-sm btn-outline-danger"
                  (click)="deleteQuestion(question.id); $event.stopPropagation()"
                  title="Eliminar pregunta"
                >
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </div>
          </div>

          
          <div *ngIf="editingQuestionId === question.id" class="card border-primary">
            <div class="card-body">
              <h5 class="card-title mb-3">Editando Pregunta</h5>
              
              <div class="mb-3">
                <label class="form-label">Texto de la pregunta <span class="text-danger">*</span></label>
                <textarea 
                  class="form-control" 
                  rows="3"
                  [(ngModel)]="question.text"
                  placeholder="Escribe tu pregunta aquí..."
                  required
                ></textarea>
                <small class="text-muted">El texto de la pregunta es obligatorio</small>
              </div>

              
              <div *ngIf="question.type === 'multiple_choice' || question.type === 'multiple_select'" class="mb-3">
                <label class="form-label">Opciones de Respuesta <span class="text-danger">*</span></label>
                <small class="text-muted d-block mb-2">Mínimo 2 opciones requeridas</small>
                <div *ngFor="let choice of question.options?.choices || []; let idx = index" class="input-group mb-2">
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="question.options!.choices![idx]"
                    [placeholder]="'Opción ' + (idx + 1)"
                  />
                  <button 
                    class="btn btn-outline-danger" 
                    type="button"
                    (click)="question.options!.choices!.splice(idx, 1)"
                  >
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </div>
                <button 
                  class="btn btn-sm btn-outline-primary"
                  (click)="(question.options?.choices || (question.options = {choices: []}).choices).push('Nueva opción')"
                >
                  <i class="fa-solid fa-plus me-1"></i>
                  Añadir Opción
                </button>
              </div>

              
              <div *ngIf="question.type === 'scale'" class="mb-3">
                <label class="form-label">Configuración de Escala</label>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label small">Mínimo</label>
                    <input 
                      type="number" 
                      class="form-control" 
                      [(ngModel)]="question.options!.min"
                    />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label small">Máximo</label>
                    <input 
                      type="number" 
                      class="form-control" 
                      [(ngModel)]="question.options!.max"
                    />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label small">Etiqueta Mínima (Opcional)</label>
                    <input 
                      type="text" 
                      class="form-control" 
                      [(ngModel)]="question.options!.min_label"
                      placeholder="Ej: Nada satisfecho"
                    />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label small">Etiqueta Máxima (Opcional)</label>
                    <input 
                      type="text" 
                      class="form-control" 
                      [(ngModel)]="question.options!.max_label"
                      placeholder="Ej: Muy satisfecho"
                    />
                  </div>
                </div>
              </div>

              
              <div *ngIf="question.type === 'candidate_vote'" class="mb-3">
                <label class="form-label">Candidatos</label>
                <div *ngFor="let candidate of question.options?.candidates || []; let idx = index" class="card mb-2">
                  <div class="card-body">
                    <div class="row g-2">
                      <div class="col-md-6">
                        <label class="form-label small">Nombre</label>
                        <input 
                          type="text" 
                          class="form-control form-control-sm" 
                          [(ngModel)]="candidate.name"
                        />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small">Imagen URL</label>
                        <input 
                          type="text" 
                          class="form-control form-control-sm" 
                          [(ngModel)]="candidate.imageUrl"
                          placeholder="URL imagen del candidato"
                        />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small">Partido</label>
                        <input 
                          type="text" 
                          class="form-control form-control-sm" 
                          [(ngModel)]="candidate.partyName"
                          placeholder="Nombre del partido"
                        />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small">Logo Partido URL</label>
                        <input 
                          type="text" 
                          class="form-control form-control-sm" 
                          [(ngModel)]="candidate.partyImageUrl"
                          placeholder="URL logo del partido"
                        />
                      </div>
                    </div>
                    <button 
                      class="btn btn-sm btn-outline-danger mt-2"
                      (click)="question.options!.candidates!.splice(idx, 1)"
                    >
                      <i class="fa-solid fa-trash me-1"></i>
                      Eliminar Candidato
                    </button>
                  </div>
                </div>
                <button 
                  class="btn btn-sm btn-outline-primary"
                  (click)="(question.options?.candidates || (question.options = {candidates: []}).candidates).push({name: 'Nuevo candidato', imageUrl: '', partyName: '', partyImageUrl: ''})"
                >
                  <i class="fa-solid fa-plus me-1"></i>
                  Añadir Candidato
                </button>
              </div>

              <div class="d-flex justify-content-end gap-2 mt-3">
                <button 
                  class="btn btn-secondary"
                  (click)="editingQuestionId = null"
                >
                  Cancelar
                </button>
                <button 
                  class="btn btn-primary"
                  (click)="saveQuestion(question)"
                  [disabled]="!question.text?.trim()"
                >
                  <i class="fa-solid fa-save me-1"></i>
                  Guardar Cambios
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    
    <div class="col-md-4">
      <div class="sticky-top" style="top: 20px;">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Componentes</h5>
          </div>
          <div class="card-body">
            <button 
              class="btn btn-outline-primary w-100 mb-2"
              (click)="addQuestion('text')"
            >
              Texto
            </button>
            <button 
              class="btn btn-outline-primary w-100 mb-2"
              (click)="addQuestion('multiple_choice')"
            >
              Opción Múltiple
            </button>
            <button 
              class="btn btn-outline-primary w-100 mb-2"
              (click)="addQuestion('multiple_select')"
            >
              Selección Múltiple
            </button>
            <button 
              class="btn btn-outline-primary w-100 mb-2"
              (click)="addQuestion('scale')"
            >
              Escala Numérica
            </button>
            <button 
              class="btn btn-outline-primary w-100 mb-2"
              (click)="addQuestion('candidate_vote')"
            >
              Voto por Candidato
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

