<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Encuestas</h2>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <i class="fa-solid fa-plus me-2"></i>
      Crear Nueva Encuesta
    </button>
  </div>

  <div *ngIf="loading" class="alert alert-info">
    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
    Cargando encuestas...
  </div>

  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <div *ngIf="!loading && !error && surveys.length === 0" class="alert alert-secondary">
    Aún no hay encuestas creadas. ¡Crea una nueva!
  </div>

  <div *ngIf="!loading && !error && surveys.length > 0" class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>Título</th>
          <th>Descripción</th>
          <th>Preguntas</th>
          <th>Estado</th>
          <th>Creada</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let survey of surveys">
          <td><strong>{{ survey.title }}</strong></td>
          <td>{{ survey.description || '-' }}</td>
          <td>{{ survey.questions_count }}</td>
          <td>
            <span [ngClass]="getStatusBadgeClass(survey.status)">
              {{ getStatusText(survey.status) }}
            </span>
          </td>
          <td>{{ survey.created_at | date: 'short' }}</td>
          <td>
            <div class="btn-group" role="group">
              <button 
                class="btn btn-sm btn-primary" 
                (click)="editSurvey(survey.id)"
                title="Editar encuesta"
              >
                <i class="fa-solid fa-edit"></i>
              </button>
              <button 
                class="btn btn-sm btn-outline-primary" 
                (click)="openRecipientsModal(survey)"
                title="Agregar destinatarios"
              >
                <i class="fa-solid fa-users me-1"></i>
                Destinatarios
              </button>
              <button 
                class="btn btn-sm btn-outline-info" 
                (click)="viewAnalytics(survey.id)"
                title="Ver analytics"
              >
                <i class="fa-solid fa-chart-bar me-1"></i>
                Analytics
              </button>
              <button 
                class="btn btn-sm btn-outline-success" 
                (click)="viewResponses(survey.id)"
                title="Ver respuestas"
              >
                <i class="fa-solid fa-list me-1"></i>
                Respuestas
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


<div 
  class="modal fade" 
  [class.show]="showCreateModal" 
  [style.display]="showCreateModal ? 'block' : 'none'"
  tabindex="-1"
  *ngIf="showCreateModal"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Crear Nueva Encuesta</h5>
        <button type="button" class="btn-close" (click)="closeCreateModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form #createForm="ngForm" (ngSubmit)="createSurvey(titleInput.value)">
          <div class="mb-3">
            <label for="survey-title" class="form-label">Título de la Encuesta</label>
            <input
              #titleInput
              type="text"
              class="form-control"
              id="survey-title"
              placeholder="Ej: Encuesta de Satisfacción del Cliente"
              required
              [disabled]="creatingSurvey"
            />
          </div>
          
          <div *ngIf="createError" class="alert alert-danger">
            {{ createError }}
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeCreateModal()" [disabled]="creatingSurvey">
          Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="createSurvey(titleInput.value)"
          [disabled]="creatingSurvey || !titleInput.value?.trim()"
        >
          <span *ngIf="creatingSurvey" class="spinner-border spinner-border-sm me-2"></span>
          {{ creatingSurvey ? 'Creando...' : 'Crear y Continuar' }}
        </button>
      </div>
    </div>
  </div>
</div>


<div 
  class="modal-backdrop fade" 
  [class.show]="showCreateModal"
  *ngIf="showCreateModal"
  (click)="closeCreateModal()"
></div>


<app-recipients-modal
  [isOpen]="showRecipientsModal"
  [surveyId]="selectedSurveyForRecipients?.id || null"
  [surveyTitle]="selectedSurveyForRecipients?.title || null"
  (onClose)="closeRecipientsModal()"
></app-recipients-modal>


