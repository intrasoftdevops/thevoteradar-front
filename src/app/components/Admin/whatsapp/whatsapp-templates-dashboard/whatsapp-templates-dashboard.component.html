<div class="whatsapp-dashboard">
  <!-- Header -->
  <div class="dashboard-header mb-4">
    <div>
      <h2 class="mb-2">
        <i class="fab fa-whatsapp me-2" [style.color]="'var(--color-primary)'"></i>
        WhatsApp Difusión
      </h2>
      <p class="text-muted mb-0">
        Gestiona tus templates de WhatsApp y envíalos a tus contactos
      </p>
    </div>
    <button
      class="btn btn-primary"
      (click)="openCreateModal()"
      [style.background-color]="'var(--color-primary)'"
      [style.border-color]="'var(--color-primary)'">
      <i class="fas fa-plus me-2"></i>
      Crear Template
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="templatesLoading" class="text-center py-5">
    <div class="spinner-border" [style.color]="'var(--color-primary)'" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="text-muted mt-3">Cargando templates...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="!templatesLoading && error" class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ error }}
    <button class="btn btn-sm btn-outline-danger ms-3" (click)="loadTemplates()">
      Reintentar
    </button>
  </div>

  <!-- Filtros y Búsqueda -->
  <div *ngIf="!templatesLoading && !error && templates.length > 0" class="filters-section mb-4">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="row g-3">
          <!-- Buscador -->
          <div class="col-md-4">
            <div class="input-group input-group-sm">
              <span class="input-group-text" [style.border-color]="'var(--color-primary)'">
                <i class="fas fa-search"></i>
              </span>
              <input
                type="text"
                class="form-control form-control-sm"
                placeholder="Buscar por nombre o contenido..."
                [(ngModel)]="searchTerm"
                (ngModelChange)="applyFilters()"
                [style.border-color]="'var(--color-primary)'">
            </div>
          </div>

          <!-- Filtro por Status -->
          <div class="col-md-2">
            <select
              class="form-select form-select-sm"
              [(ngModel)]="selectedStatus"
              (ngModelChange)="applyFilters()"
              [style.border-color]="'var(--color-primary)'">
              <option value="">Todos los departamentos</option>
              <option value="pending">Pendiente</option>
              <option value="created">Aprobado</option>
              <option value="failed">Rechazado</option>
            </select>
          </div>

          <!-- Filtro por Categoría -->
          <div class="col-md-2">
            <select
              class="form-select form-select-sm"
              [(ngModel)]="selectedCategory"
              (ngModelChange)="applyFilters()"
              [style.border-color]="'var(--color-primary)'">
              <option value="">Todas las categorías</option>
              <option value="MARKETING">Marketing</option>
              <option value="UTILITY">Utilidad</option>
              <option value="AUTHENTICATION">Autenticación</option>
            </select>
          </div>

          <!-- Ordenar -->
          <div class="col-md-2">
            <select
              class="form-select form-select-sm"
              [(ngModel)]="sortBy"
              (ngModelChange)="applyFilters()"
              [style.border-color]="'var(--color-primary)'">
              <option value="date">Más recientes</option>
              <option value="name">Nombre</option>
              <option value="status">Estado</option>
            </select>
          </div>

          <!-- Botón Limpiar -->
          <div class="col-md-2">
            <button
              class="btn btn-sm btn-outline-secondary w-100"
              (click)="clearFilters()"
              [disabled]="!searchTerm && !selectedStatus && !selectedCategory">
              <i class="fas fa-times me-1"></i>
              Limpiar
            </button>
          </div>
        </div>

        <!-- Contador de resultados -->
        <div class="mt-2 text-muted small">
          <i class="fas fa-file-alt me-1"></i>
          Mostrando {{ filteredTemplates.length }} de {{ templates.length }} templates
        </div>
      </div>
    </div>
  </div>

  <!-- Templates List (SOLO TEMPLATES REALES) -->
  <div *ngIf="!templatesLoading && !error && filteredTemplates.length > 0" class="templates-list">
    <div class="row g-4">
      <div *ngFor="let template of filteredTemplates" class="col-md-6 col-lg-4">
        <div class="card border-0 shadow-sm h-100 template-card">
          <div class="card-body">
            <h5 class="card-title mb-2">{{ template.template_name }}</h5>
            <div class="d-flex justify-content-end mb-3">
              <span class="badge status-badge" [ngClass]="getStatusBadgeClass(template.status)">
                {{ getStatusLabel(template.status) }}
              </span>
            </div>
            
            <p class="card-text text-muted small mb-3" [title]="template.template_content">
              {{ truncateText(template.template_content, 120) }}
            </p>

            <div class="template-meta mb-3">
              <div class="d-flex flex-wrap gap-2">
                <span class="badge bg-light text-dark" *ngIf="template.category">
                  <i class="fas fa-tag me-1"></i>
                  {{ getCategoryLabel(template.category) }}
                </span>
                <span class="badge bg-light text-dark" *ngIf="template.parameters && template.parameters.length > 0">
                  <i class="fas fa-code me-1"></i>
                  {{ template.parameters.length }} {{ template.parameters.length === 1 ? 'parámetro' : 'parámetros' }}
                </span>
              </div>
            </div>

            <div class="template-actions">
              <button
                *ngIf="isApproved(template)"
                class="btn btn-sm btn-success w-100"
                (click)="openSendModal(template)"
                [style.background-color]="'#28a745'"
                [style.border-color]="'#28a745'">
                <i class="fas fa-paper-plane me-2"></i>
                Enviar Template
              </button>
              <button
                *ngIf="!isApproved(template)"
                class="btn btn-sm btn-outline-secondary w-100"
                disabled>
                <i class="fas fa-clock me-2"></i>
                {{ template.status === 'pending' ? 'Pendiente de aprobación' : template.status === 'failed' ? 'Rechazado' : 'No disponible' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State después de filtrar -->
  <div *ngIf="!templatesLoading && !error && templates.length > 0 && filteredTemplates.length === 0" class="text-center py-5">
    <i class="fas fa-filter fa-3x mb-3" [style.color]="'var(--color-primary)'" style="opacity: 0.3;"></i>
    <h5 class="mb-3">No se encontraron templates</h5>
    <p class="text-muted mb-4">
      No hay templates que coincidan con los filtros seleccionados
    </p>
    <button
      class="btn btn-outline-secondary"
      (click)="clearFilters()">
      <i class="fas fa-times me-2"></i>
      Limpiar filtros
    </button>
  </div>

  <!-- Empty State sin templates -->
  <div *ngIf="!templatesLoading && !error && templates.length === 0" class="empty-state text-center py-5">
    <i class="fab fa-whatsapp fa-4x mb-3" [style.color]="'var(--color-primary)'" style="opacity: 0.3;"></i>
    <h4 class="mb-3">No tienes templates creados aún</h4>
    <p class="text-muted mb-4">
      Crea tu primer template de WhatsApp para comenzar a enviar mensajes a tus contactos
    </p>
    <button
      class="btn btn-primary"
      (click)="openCreateModal()"
      [style.background-color]="'var(--color-primary)'"
      [style.border-color]="'var(--color-primary)'">
      <i class="fas fa-plus me-2"></i>
      Crear mi primer template
    </button>
  </div>

  <!-- Modal Crear Template -->
  <div 
    *ngIf="showCreateModal"
    class="modal fade show" 
    style="display: block !important; z-index: 1055 !important; position: fixed !important;"
    tabindex="-1" 
    role="dialog"
    (click)="$event.target === $event.currentTarget && closeCreateModal()">
    <div class="modal-dialog modal-lg" role="document" (click)="$event.stopPropagation()" style="z-index: 1056; position: relative;">
      <div class="modal-content" style="position: relative; z-index: 1057;">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-plus-circle me-2" [style.color]="'var(--color-primary)'"></i>
            Crear Nuevo Template
          </h5>
          <button type="button" class="btn-close" (click)="closeCreateModal()" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <!-- Success message -->
          <div *ngIf="createSuccess" class="alert alert-success" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            ¡Template creado exitosamente! Ahora está pendiente de aprobación.
          </div>

          <!-- Error message -->
          <div *ngIf="error" class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {{ error }}
          </div>

          <!-- Form -->
          <form (ngSubmit)="onCreateTemplate()">
            <div class="mb-3">
              <label class="form-label">Nombre del Template *</label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="formData.template_name"
                name="template_name"
                placeholder="ej: promo_enero_2024"
                required>
            </div>

            <div class="mb-3">
              <label class="form-label">Contenido del Template *</label>
              <textarea
                class="form-control"
                [(ngModel)]="formData.template_content"
                name="template_content"
                rows="4"
                required></textarea>
              <small class="form-text text-muted">
                Usa <code>{{ "{{variable}}" }}</code> para parámetros dinámicos. Ejemplo: 
                <code ngNonBindable>Hola {{name}}, ¡Tenemos una oferta especial! Descuento: {{discount}}</code>
              </small>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Categoría</label>
                <select
                  class="form-select"
                  [(ngModel)]="formData.category"
                  name="category">
                  <option value="MARKETING">Marketing</option>
                  <option value="UTILITY">Utilidad</option>
                  <option value="AUTHENTICATION">Autenticación</option>
                </select>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Idioma</label>
                <select
                  class="form-select"
                  [(ngModel)]="formData.language"
                  name="language">
                  <option value="es">Español</option>
                  <option value="en">Inglés</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Notas (opcional)</label>
              <textarea
                class="form-control"
                [(ngModel)]="formData.notes"
                name="notes"
                rows="2"
                placeholder="Notas adicionales sobre el template..."></textarea>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" (click)="closeCreateModal()" [disabled]="creating">
                Cancelar
              </button>
              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="creating"
                [style.background-color]="'var(--color-primary)'"
                [style.border-color]="'var(--color-primary)'">
                <span *ngIf="creating" class="spinner-border spinner-border-sm me-2" role="status"></span>
                {{ creating ? 'Creando...' : 'Crear Template' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div *ngIf="showCreateModal" class="modal-backdrop fade show" style="z-index: 1054 !important;"></div>

  <!-- Modal Enviar Template -->
  <app-send-template-modal
    *ngIf="showSendModal && selectedTemplate"
    [isOpen]="showSendModal"
    [template]="selectedTemplate"
    (close)="closeSendModal()"
    (success)="onSendSuccess()">
  </app-send-template-modal>
</div>
