<div class="min-h-screen" [style.background]="'linear-gradient(to bottom right, rgba(var(--color-primary-rgb), 0.05), white, rgba(var(--color-primary-rgb), 0.05))'">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 overflow-hidden mb-6">
      <div class="p-6 sm:p-8 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4" [style.background]="'linear-gradient(to right, var(--color-primary), var(--color-accent))'">
        <h2 class="text-2xl sm:text-3xl font-bold text-white mb-0">Consultar testigos</h2>
        <button
          class="bg-white text-sm sm:text-base px-4 sm:px-6 py-2 sm:py-3 rounded-lg hover:bg-gray-100 transition-all duration-200 flex items-center gap-2 font-semibold"
          [style.color]="'var(--color-primary)'"
          routerLink="/panel/usuarios/testigo/crear"
          title="Crear nuevo testigo"
        >
          <i class="fa-solid fa-plus"></i>
          Crear Testigo
        </button>
      </div>
    </div>

    <!-- Filtros -->
    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 overflow-hidden mb-6">
      <div class="p-6 sm:p-8">
        <div class="flex items-center gap-3 mb-6">
          <div class="p-2 rounded-lg" [style.background]="'linear-gradient(to right, var(--color-primary), var(--color-accent))'">
            <i class="fas fa-filter text-white text-lg"></i>
          </div>
          <h3 class="text-xl font-bold text-gray-900">Filtros de Búsqueda</h3>
        </div>
        <form [formGroup]="searchForm">
          <!-- Flujo para Admin: Departamento -> Municipio -> Zona -> Puesto -->
          <div *ngIf="isAdmin" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Departamento</label>
              <ng-select
                [items]="dataDepartments"
                [searchable]="true"
                class="custom-select rounded"
                bindLabel="nombre_departamento_votacion"
                (change)="getSelectedDepartment()"
                bindValue="codigo_unico"
                placeholder="Seleccione departamento"
                formControlName="departamento"
                [clearable]="true"
              >
              </ng-select>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Municipio</label>
              <ng-select
                [items]="dataMunicipals"
                [searchable]="true"
                class="custom-select rounded"
                bindLabel="nombre_municipio_votacion"
                (change)="getSelectedMunicipal()"
                bindValue="codigo_unico"
                placeholder="Seleccione municipio"
                formControlName="municipio"
                [clearable]="true"
                [loading]="loadingMunicipios"
                [disabled]="!selectedDepartment"
              >
              </ng-select>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Zona</label>
              <ng-select
                [items]="dataZones"
                [searchable]="true"
                class="custom-select rounded"
                bindLabel="nombre"
                (change)="getSelectedZone()"
                bindValue="codigo_unico"
                placeholder="Seleccione zona"
                formControlName="zona"
                [clearable]="true"
                [loading]="loadingZonas"
                [disabled]="!selectedMunicipal"
              >
              </ng-select>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Puesto</label>
              <ng-select
                [items]="dataStations"
                [searchable]="true"
                class="custom-select rounded"
                bindLabel="nombre"
                (change)="getSelectedStation($event)"
                bindValue="codigo_unico"
                placeholder="Seleccione puesto"
                formControlName="puestos"
                [clearable]="true"
                [loading]="loadingPuestos"
                [disabled]="!selectedZone"
              >
              </ng-select>
            </div>
          </div>
          
          <!-- Flujo para Coordinador: Puesto directo -->
          <div *ngIf="!isAdmin" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Testigos por puesto</label>
              <ng-select
                [items]="dataStations"
                [searchable]="false"
                class="custom-select rounded"
                bindLabel="nombre"
                (change)="getSelectedStation($event)"
                bindValue="codigo_unico"
                información="No hay información disponible"
                placeholder="Seleccione puesto"
                formControlName="puestos"
                [clearAllText]="'Borrar todo'"
              >
              </ng-select>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 overflow-hidden mb-6">
      <ul class="nav flex border-b" id="myTab" role="tablist">
        <li class="nav-item flex-1" role="presentation">
          <button
            class="nav-link w-full py-4 px-6 text-base sm:text-lg font-semibold transition-all duration-200 border-b-2"
            [style.border-bottom-color]="activeTab === 'asignados' ? 'var(--color-primary)' : 'transparent'"
            [style.color]="activeTab === 'asignados' ? 'var(--color-primary)' : '#6b7280'"
            id="home-tab"
            data-bs-toggle="tab"
            data-bs-target="#asignados"
            type="button"
            role="tab"
            (click)="setActiveTab('asignados')"
          >
            Asignados
          </button>
        </li>
        <li class="nav-item flex-1" role="presentation">
          <button
            class="nav-link w-full py-4 px-6 text-base sm:text-lg font-semibold transition-all duration-200 border-b-2"
            [style.border-bottom-color]="activeTab === 'noasignados' ? 'var(--color-primary)' : 'transparent'"
            [style.color]="activeTab === 'noasignados' ? 'var(--color-primary)' : '#6b7280'"
            id="profile-tab"
            data-bs-toggle="tab"
            data-bs-target="#noasignados"
            type="button"
            role="tab"
            (click)="setActiveTab('noasignados')"
          >
            No asignados
          </button>
        </li>
      </ul>
      <div class="tab-content p-6 sm:p-8" id="myTabContent">
        <div class="tab-pane fade show active" id="asignados" role="tabpanel">
          <!-- Loading State -->
          <div *ngIf="loading" class="flex items-center justify-center py-12">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2" [style.border-color]="'var(--color-primary)'"></div>
            <span class="ml-3 text-gray-600 text-lg">Cargando testigos...</span>
          </div>
          
          <div
            class="table-responsive my-4"
            *ngIf="!loading && listTestigoAsignados.length > 0; else mesa_content"
          >
            <table
              datatable
              [dtOptions]="dtOptionsTestigoAsignados"
              [dtTrigger]="dtTrigger"
              class="table text-center align-middle w-100"
            >
              <thead class="align-middle" [style.background]="'linear-gradient(to right, rgba(var(--color-primary-rgb), 0.1), rgba(var(--color-primary-rgb), 0.15))'">
                <tr>
                  <th scope="col" class="font-semibold py-4 px-4" [style.color]="'var(--color-primary)'">NOMBRE COMPLETO</th>
                  <th scope="col" class="font-semibold py-4 px-4" [style.color]="'var(--color-primary)'">TELEFONO</th>
                  <th scope="col" class="font-semibold py-4 px-4" [style.color]="'var(--color-primary)'">CORREO ELECTRÓNICO</th>
                  <th scope="col" class="font-semibold py-4 px-4" [style.color]="'var(--color-primary)'">MESA</th>
                  <th scope="col" class="font-semibold py-4 px-4" [style.color]="'var(--color-primary)'"></th>
                </tr>
              </thead>
              <tbody>
                <tr
                  class="text-center hover:bg-gray-50 transition-colors duration-200 border-b border-gray-100"
                  *ngFor="
                    let testigo of listTestigoAsignados;
                    let index = index
                  "
                >
                  <td class="py-4 px-4 text-gray-900 font-medium">{{ testigo.nombres }} {{ testigo.apellidos }}</td>
                  <td class="py-4 px-4 text-gray-700">
                    {{ testigo.telefono ? testigo.telefono : "Sin registro" }}
                  </td>
                  <td class="py-4 px-4 text-gray-700">{{ testigo.email }}</td>
                  <td class="py-4 px-4 text-gray-700">
                    <span
                      *ngFor="
                        let mesa of testigo.mesas;
                        let i = index;
                        let last = last
                      "
                    >
                      {{ mesa.numero_mesa
                      }}{{ i < testigo.mesas.length - 1 ? ", " : "" }}
                    </span>
                  </td>
                  <td class="py-4 px-4">
                    <div
                      class="flex flex-wrap gap-2 justify-center items-center"
                    >
                      <button
                        class="p-2 rounded-lg hover:bg-gray-100 transition-all duration-200"
                        [style.color]="'var(--color-primary)'"
                        data-bs-toggle="modal"
                        data-bs-target="#testigo"
                        (click)="
                          testigoActualSeleccionado(
                            testigo,
                            testigosMesas[testigo.id]
                          )
                        "
                        data-bs-placement="top"
                        title="Ver más"
                      >
                        <i class="fa-solid fa-eye"></i>
                      </button>
                      <button
                        class="p-2 rounded-lg hover:bg-gray-100 transition-all duration-200"
                        [style.color]="'var(--color-primary)'"
                        (click)="redirectUpdateTestigo(testigo.id)"
                        data-bs-placement="top"
                        title="Editar información"
                      >
                        <i class="fa-solid fa-pen"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #mesa_content>
            <div class="text-center py-12" *ngIf="!loading">
              <i class="fas fa-users text-5xl mb-4" [style.color]="'rgba(var(--color-primary-rgb), 0.3)'"></i>
              <p class="text-gray-600 text-lg">
                No hay testigos con asignación de mesa.
              </p>
            </div>
          </ng-template>
        </div>
        <div class="tab-pane fade" id="noasignados" role="tabpanel">
          <!-- Loading State -->
          <div *ngIf="loading" class="flex items-center justify-center py-12">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2" [style.border-color]="'var(--color-primary)'"></div>
            <span class="ml-3 text-gray-600 text-lg">Cargando testigos...</span>
          </div>
          
          <div
            class="table-responsive my-4"
            *ngIf="!loading && listTestigoNoAsignados.length > 0; else no_mesa_content"
          >
            <table
              datatable
              [dtOptions]="dtOptionsTestigoNoAsignados"
              [dtTrigger]="dtTrigger"
              class="table text-center align-middle w-100"
            >
              <thead class="align-middle" [style.background]="'linear-gradient(to right, rgba(var(--color-primary-rgb), 0.1), rgba(var(--color-primary-rgb), 0.15))'">
                <tr>
                  <th scope="col" class="font-semibold py-4 px-4" [style.color]="'var(--color-primary)'">NOMBRE COMPLETO</th>
                  <th scope="col" class="font-semibold py-4 px-4" [style.color]="'var(--color-primary)'">TELÉFONO</th>
                  <th scope="col" class="font-semibold py-4 px-4" [style.color]="'var(--color-primary)'">CORREO ELECTRÓNICO</th>
                  <th scope="col" class="font-semibold py-4 px-4" [style.color]="'var(--color-primary)'"></th>
                </tr>
              </thead>
              <tbody>
                <tr
                  class="text-center hover:bg-gray-50 transition-colors duration-200 border-b border-gray-100"
                  *ngFor="let testigo of listTestigoNoAsignados"
                >
                  <td class="py-4 px-4 text-gray-900 font-medium">{{ testigo.nombres }} {{ testigo.apellidos }}</td>
                  <td class="py-4 px-4 text-gray-700">{{ testigo.telefono }}</td>
                  <td class="py-4 px-4 text-gray-700">{{ testigo.email }}</td>
                  <td class="py-4 px-4">
                    <div
                      class="flex flex-wrap gap-2 justify-center items-center"
                    >
                      <button
                        class="p-2 rounded-lg hover:bg-gray-100 transition-all duration-200"
                        [style.color]="'var(--color-primary)'"
                        data-bs-toggle="modal"
                        data-bs-target="#testigo"
                        (click)="testigoActualSeleccionado(testigo)"
                        data-bs-placement="top"
                        title="Ver más"
                      >
                        <i class="fa-solid fa-eye"></i>
                      </button>
                      <button
                        class="p-2 rounded-lg hover:bg-gray-100 transition-all duration-200"
                        [style.color]="'var(--color-primary)'"
                        (click)="redirectUpdateTestigo(testigo.id)"
                        data-bs-placement="top"
                        title="Editar información"
                      >
                        <i class="fa-solid fa-pen"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #no_mesa_content>
            <div class="text-center py-12" *ngIf="!loading">
              <i class="fas fa-users text-5xl mb-4" [style.color]="'rgba(var(--color-primary-rgb), 0.3)'"></i>
              <p class="text-gray-600 text-lg">
                No hay testigos sin asignación de mesa.
              </p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="testigo"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content rounded-2xl overflow-hidden">
      <div class="modal-header text-white py-4 px-6" [style.background]="'linear-gradient(to right, var(--color-primary), var(--color-accent))'">
        <h5 class="modal-title font-bold text-xl" id="exampleModalLabel">Información</h5>
        <button
          type="button"
          class="bg-transparent border-0 text-white hover:bg-white/20 rounded-lg p-2 transition-all duration-200"
          data-bs-dismiss="modal"
          aria-label="Close"
        >
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <p>
          <span class="fw-bolder">Nombre completo: </span
          ><span>
            {{ testigoActual.nombres }} {{ testigoActual.apellidos }}</span
          >
        </p>
        <p>
          <span class="fw-bolder">Teléfono: </span
          ><span> {{ testigoActual.telefono }}</span>
        </p>
        <p>
          <span class="fw-bolder">Correo electrónico: </span
          ><span> {{ testigoActual.email }}</span>
        </p>
        <p>
          <span class="fw-bolder">Número de documento: </span
          ><span> {{ testigoActual.numero_documento }}</span>
        </p>
        <p [ngClass]="{ 'd-none': !mesasActual }">
          <span class="fw-bolder">Mesas: </span><span> {{ mesasActual }}</span>
        </p>
      </div>
    </div>
  </div>
</div>
