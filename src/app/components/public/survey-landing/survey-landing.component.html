<div class="survey-landing-container">
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-3 text-muted">Cargando encuesta...</p>
  </div>

  <div *ngIf="error && !loading" class="alert alert-danger mx-auto" style="max-width: 600px;">
    <h5 class="alert-heading">Error</h5>
    <p class="mb-0">{{ error }}</p>
  </div>

  <div *ngIf="success" class="text-center py-5">
    <div class="card mx-auto" style="max-width: 600px;">
      <div class="card-body">
        <div class="mb-4">
          <i class="fa-solid fa-check-circle text-success" style="font-size: 4rem;"></i>
        </div>
        <h2 class="card-title">¡Gracias por participar!</h2>
        <p class="card-text text-muted">Tu respuesta ha sido registrada exitosamente.</p>
      </div>
    </div>
  </div>

  <div *ngIf="!loading && !error && !success && questions.length > 0" class="survey-form-container">
    <div class="card mx-auto" style="max-width: 800px;">
      <div class="card-header bg-primary text-white text-center">
        <h2 class="mb-0">{{ surveyTitle || 'Encuesta' }}</h2>
        <p *ngIf="surveyDescription" class="mb-0 mt-2">{{ surveyDescription }}</p>
      </div>
      <div class="card-body p-4">
        <form (ngSubmit)="submitSurvey()">
          <div *ngFor="let question of questions" class="mb-4 question-block">
            <!-- Text Question -->
            <div *ngIf="question.type === 'text'">
              <label [for]="'q-' + question.id" class="form-label fw-bold">
                {{ question.text }}
                <span *ngIf="question.required" class="text-danger">*</span>
              </label>
              <input
                [id]="'q-' + question.id"
                type="text"
                class="form-control"
                [value]="getResponse(question.id) || ''"
                (input)="updateResponse(question.id, $any($event.target).value)"
                [required]="question.required"
              />
            </div>

            <!-- Multiple Choice Question -->
            <div *ngIf="question.type === 'multiple_choice'">
              <label class="form-label fw-bold">
                {{ question.text }}
                <span *ngIf="question.required" class="text-danger">*</span>
              </label>
              <div class="mt-2">
                <div *ngFor="let choice of question.options?.choices; let i = index" class="form-check mb-2">
                  <input
                    class="form-check-input"
                    type="radio"
                    [name]="'q-' + question.id"
                    [id]="'q-' + question.id + '-' + i"
                    [value]="choice"
                    [checked]="getResponse(question.id) === choice"
                    (change)="updateResponse(question.id, choice)"
                    [required]="question.required"
                  />
                  <label class="form-check-label" [for]="'q-' + question.id + '-' + i">
                    {{ choice }}
                  </label>
                </div>
              </div>
            </div>

            <!-- Multiple Select Question -->
            <div *ngIf="question.type === 'multiple_select'">
              <label class="form-label fw-bold">
                {{ question.text }}
                <span *ngIf="question.required" class="text-danger">*</span>
              </label>
              <div class="mt-2">
                <div *ngFor="let choice of question.options?.choices; let i = index" class="form-check mb-2">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    [id]="'q-' + question.id + '-' + i"
                    [value]="choice"
                    [checked]="(getResponse(question.id) || []).includes(choice)"
                    (change)="toggleMultipleSelect(question.id, choice)"
                  />
                  <label class="form-check-label" [for]="'q-' + question.id + '-' + i">
                    {{ choice }}
                  </label>
                </div>
              </div>
            </div>

            <!-- Scale Question -->
            <div *ngIf="question.type === 'scale'">
              <label class="form-label fw-bold">
                {{ question.text }}
                <span *ngIf="question.required" class="text-danger">*</span>
              </label>
              <div class="mt-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-muted small">{{ question.options?.min_label || 'Mínimo' }}</span>
                  <span class="text-muted small">{{ question.options?.max_label || 'Máximo' }}</span>
                </div>
                <div class="d-flex justify-content-between">
                  <div *ngFor="let num of getScaleRange(question)" class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      [name]="'q-' + question.id"
                      [id]="'q-' + question.id + '-' + num"
                      [value]="num"
                      [checked]="getResponse(question.id) === num"
                      (change)="updateResponse(question.id, num)"
                      [required]="question.required"
                    />
                    <label class="form-check-label" [for]="'q-' + question.id + '-' + num">
                      {{ num }}
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Candidate Vote Question -->
            <div *ngIf="question.type === 'candidate_vote'">
              <label class="form-label fw-bold text-center d-block mb-3">
                {{ question.text }}
                <span *ngIf="question.required" class="text-danger">*</span>
              </label>
              <div class="row g-3">
                <div *ngFor="let candidate of question.options?.candidates; let i = index" class="col-md-6">
                  <div
                    class="card candidate-card"
                    [class.selected]="getResponse(question.id) === i"
                    (click)="updateResponse(question.id, i)"
                    style="cursor: pointer;"
                  >
                    <div class="card-body text-center">
                      <img
                        [src]="candidate.imageUrl || 'https://via.placeholder.com/150'"
                        [alt]="candidate.name"
                        class="candidate-image mb-3"
                      />
                      <h5 class="card-title">{{ candidate.name }}</h5>
                      <p *ngIf="candidate.partyName" class="text-muted small">{{ candidate.partyName }}</p>
                      <p *ngIf="candidate.vicePresidentName" class="text-muted small">Vice: {{ candidate.vicePresidentName }}</p>
                      <img
                        *ngIf="candidate.partyImageUrl"
                        [src]="candidate.partyImageUrl"
                        alt="Partido"
                        class="party-image mt-2"
                      />
                      <div *ngIf="getResponse(question.id) === i" class="selected-indicator">
                        <i class="fa-solid fa-check-circle text-success"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="button" class="btn btn-secondary" (click)="clearResponses()">
              Reiniciar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="submitting">
              <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2"></span>
              {{ submitting ? 'Enviando...' : 'Enviar Respuestas' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

