name: Deploy thevoteradar-front (dev/prod)

on:
  push:
    branches: [ dev, main ]

env:
  GCP_PROJECT_ID: political-referrals
  GCP_REGION: us-central1

jobs:
  deploy:
    name: Deploy thevoteradar-front (${{ matrix.env_name }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - branch: dev
            env_name: dev
            service_name: thevoteradar-front-dev
          - branch: main
            env_name: prod
            service_name: thevoteradar-front-prod
    steps:
      - name: Checkout
        if: github.ref_name == matrix.branch
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        if: github.ref_name == matrix.branch
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud CLI
        if: github.ref_name == matrix.branch
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Verify gcloud auth
        if: github.ref_name == matrix.branch
        run: |
          gcloud auth list
          gcloud config list project
          echo "‚úÖ Authenticated successfully"

      - name: Deploy ${{ matrix.service_name }}
        if: github.ref_name == matrix.branch
        run: |
          # Deploy con configuraci√≥n para frontend est√°tico
          gcloud run deploy "${{ matrix.service_name }}" \
            --project "${{ env.GCP_PROJECT_ID }}" \
            --region "${{ env.GCP_REGION }}" \
            --source . \
            --allow-unauthenticated \
            --clear-base-image \
            --memory=512Mi \
            --cpu=1 \
            --max-instances=10 \
            --min-instances=0 \
            --timeout=300s \
            --concurrency=80 \
            --port=8080
          
          # Esperar un momento para que el servicio se inicie
          echo "‚è≥ Esperando que el servicio se inicie..."
          sleep 15
          
          # Obtener la URL del servicio desplegado
          SERVICE_URL=$(gcloud run services describe "${{ matrix.service_name }}" \
            --project "${{ env.GCP_PROJECT_ID }}" \
            --region "${{ env.GCP_REGION }}" \
            --format="value(status.url)")
          
          echo "üîó URL del servicio: $SERVICE_URL"
          
          # Hacer health check
          echo "üè• Ejecutando health check..."
          curl -f "$SERVICE_URL" || {
            echo "‚ö†Ô∏è Health check fall√≥, pero el servicio puede estar inici√°ndose..."
            echo "üîÑ Reintentando en 15 segundos..."
            sleep 15
            curl -f "$SERVICE_URL" || {
              echo "‚ùå Health check fall√≥ despu√©s del segundo intento"
              echo "‚ÑπÔ∏è El servicio puede estar funcionando, pero el health check no respondi√≥"
            }
          }
          
          echo "‚úÖ Servicio desplegado exitosamente"
          echo "üéâ Deploy completado - thevoteradar-front ${{ matrix.env_name }} est√° en l√≠nea"


