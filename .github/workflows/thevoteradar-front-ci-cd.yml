name: CI/CD Pipeline - thevoteradar-front

on:
  push:
    branches: [ main, dev ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: üîë Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: ‚òÅÔ∏è Setup gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ vars.GCP_PROJECT_ID }}

    - name: ‚úÖ Verify gcloud auth
      run: |
        gcloud auth list
        gcloud config list project
        echo "‚úÖ Authenticated successfully"

    - name: üê≥ Configure Docker for GCR
      run: gcloud auth configure-docker --quiet

    - name: üì¶ Install dependencies
      run: npm ci --no-audit --no-fund

    - name: üîê Preparar configuraci√≥n para variables de entorno en Cloud Run
      run: |
        SECRET_PREFIX="thevoteradar"
        
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          ENV_SUFFIX="prod"
          PRODUCTION="true"
          DEVELOPMENT="false"
          echo "üî¥ PRODUCTION environment detected"
        else
          ENV_SUFFIX="dev"
          PRODUCTION="false"
          DEVELOPMENT="true"
          echo "üü¢ DEVELOPMENT environment detected"
        fi
        
        # Guardar nombres de secretos para usar en el deploy
        echo "KEY1_SECRET_NAME=$SECRET_PREFIX-key1-$ENV_SUFFIX:latest" >> $GITHUB_ENV
        echo "KEY2_SECRET_NAME=$SECRET_PREFIX-key2-$ENV_SUFFIX:latest" >> $GITHUB_ENV
        echo "KEY3_SECRET_NAME=$SECRET_PREFIX-key3-$ENV_SUFFIX:latest" >> $GITHUB_ENV
        echo "KEY4_SECRET_NAME=$SECRET_PREFIX-key4-$ENV_SUFFIX:latest" >> $GITHUB_ENV
        echo "API_URL_SECRET_NAME=$SECRET_PREFIX-api-url-$ENV_SUFFIX:latest" >> $GITHUB_ENV
        echo "BACKOFFICE_API_URL_SECRET_NAME=$SECRET_PREFIX-backoffice-api-url-$ENV_SUFFIX:latest" >> $GITHUB_ENV
        echo "SURVEY_API_URL_SECRET_NAME=$SECRET_PREFIX-survey-api-url-$ENV_SUFFIX:latest" >> $GITHUB_ENV
        echo "DEFAULT_TENANT_ID_SECRET_NAME=$SECRET_PREFIX-default-tenant-id-$ENV_SUFFIX:latest" >> $GITHUB_ENV
        echo "POWER_BI_URL_SECRET_NAME=$SECRET_PREFIX-powerbi-url-$ENV_SUFFIX:latest" >> $GITHUB_ENV
        echo "PRODUCTION=$PRODUCTION" >> $GITHUB_ENV
        echo "DEVELOPMENT=$DEVELOPMENT" >> $GITHUB_ENV
        echo "ENV_SUFFIX=$ENV_SUFFIX" >> $GITHUB_ENV
        
        echo "‚úÖ Variables de entorno se configurar√°n en Cloud Run desde Secret Manager"
        echo "‚ÑπÔ∏è Las variables se inyectar√°n en runtime mediante el script de inicio de nginx"

    - name: üß™ Run tests (if available)
      run: |
        if npm run | grep -q "test"; then
          npm test -- --watch=false --browsers=ChromeHeadless
        else
          echo "No tests configured, skipping..."
        fi
      continue-on-error: true

    - name: üê≥ Build & Push Docker image
      run: |
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          TAG="prod-${{ github.sha }}"
          SERVICE_NAME="thevoteradar-front-prod"
          ENVIRONMENT="production"
        else
          TAG="dev-${{ github.sha }}"
          SERVICE_NAME="thevoteradar-front-dev"
          ENVIRONMENT="development"
        fi

        echo "Building image: gcr.io/${{ vars.GCP_PROJECT_ID }}/thevoteradar-front:$TAG"
        echo "Deploying service: $SERVICE_NAME in $ENVIRONMENT"

        docker build -t gcr.io/${{ vars.GCP_PROJECT_ID }}/thevoteradar-front:$TAG .
        docker push gcr.io/${{ vars.GCP_PROJECT_ID }}/thevoteradar-front:$TAG

        echo "TAG=$TAG" >> $GITHUB_ENV
        echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
        echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV

    - name: üöÄ Deploy to Cloud Run
      run: |
        echo "üöÄ Desplegando servicio con variables de entorno desde Secret Manager..."
        gcloud run deploy $SERVICE_NAME \
          --image gcr.io/${{ vars.GCP_PROJECT_ID }}/thevoteradar-front:$TAG \
          --region ${{ vars.GCP_REGION }} \
          --platform managed \
          --allow-unauthenticated \
          --port 8080 \
          --set-env-vars ENVIRONMENT=$ENVIRONMENT,PRODUCTION=$PRODUCTION,DEVELOPMENT=$DEVELOPMENT \
          --set-secrets KEY1=$KEY1_SECRET_NAME \
          --set-secrets KEY2=$KEY2_SECRET_NAME \
          --set-secrets KEY3=$KEY3_SECRET_NAME \
          --set-secrets KEY4=$KEY4_SECRET_NAME \
          --set-secrets API_URL=$API_URL_SECRET_NAME \
          --set-secrets BACKOFFICE_API_URL=$BACKOFFICE_API_URL_SECRET_NAME \
          --set-secrets SURVEY_API_URL=$SURVEY_API_URL_SECRET_NAME \
          --set-secrets DEFAULT_TENANT_ID=$DEFAULT_TENANT_ID_SECRET_NAME \
          --set-secrets POWER_BI_URL=$POWER_BI_URL_SECRET_NAME \
          --memory=512Mi \
          --cpu=1 \
          --max-instances=10 \
          --min-instances=1 \
          --concurrency=80 \
          --timeout=300s
        echo "‚úÖ Servicio desplegado con variables de entorno desde Secret Manager configuradas"

    - name: üì° Get service URL and health check
      run: |
        echo "‚è≥ Esperando que el servicio se inicie..."
        sleep 15
        
        SERVICE_URL=$(gcloud run services describe $SERVICE_NAME \
          --project ${{ vars.GCP_PROJECT_ID }} \
          --region ${{ vars.GCP_REGION }} \
          --format="value(status.url)")
        
        echo "‚úÖ Deployment completed!"
        echo "üîó URL del servicio: $SERVICE_URL"
        echo "üè∑Ô∏è Image tag: $TAG"
        echo "üîß Environment: $ENVIRONMENT"
        
        echo "üè• Ejecutando health check..."
        curl -f "$SERVICE_URL" || {
          echo "‚ö†Ô∏è Health check fall√≥, pero el servicio puede estar inici√°ndose..."
          echo "üîÑ Reintentando en 15 segundos..."
          sleep 15
          curl -f "$SERVICE_URL" || {
            echo "‚ùå Health check fall√≥ despu√©s del segundo intento"
            echo "‚ÑπÔ∏è El servicio puede estar funcionando, pero el health check no respondi√≥"
            exit 1
          }
        }
        
        echo "‚úÖ Health check exitoso"
        echo "üéâ Deploy completado - thevoteradar-front $ENVIRONMENT est√° en l√≠nea"

