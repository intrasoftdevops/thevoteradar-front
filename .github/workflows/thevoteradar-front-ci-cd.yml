name: CI/CD Pipeline - thevoteradar-front

on:
  push:
    branches: [ main, dev ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod

env:
  PROJECT_ID: political-referrals
  REGION: us-central1
  IMAGE_NAME: thevoteradar-front

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: ğŸ”‘ Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: â˜ï¸ Setup gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        export_default_credentials: true

    - name: ğŸ³ Configure Docker for GCR
      run: gcloud auth configure-docker --quiet

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ§ª Run tests (if available)
      run: |
        if npm run | grep -q "test"; then
          npm test -- --watch=false --browsers=ChromeHeadless
        else
          echo "No tests configured, skipping..."
        fi
      continue-on-error: true

    - name: ğŸ³ Build & Push Docker image
      run: |
        # Determinar el tag y servicio segÃºn la rama
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          TAG="prod-${{ github.sha }}"
          SERVICE_NAME="thevoteradar-front-prod"
          ENVIRONMENT="production"
        else
          TAG="dev-${{ github.sha }}"
          SERVICE_NAME="thevoteradar-front-dev"
          ENVIRONMENT="development"
        fi

        echo "Building image: gcr.io/${{ env.PROJECT_ID }}/${{ env.IMAGE_NAME }}:$TAG"
        echo "Deploying service: $SERVICE_NAME in $ENVIRONMENT"

        docker build -t gcr.io/${{ env.PROJECT_ID }}/${{ env.IMAGE_NAME }}:$TAG .
        docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.IMAGE_NAME }}:$TAG

        # Exportar a env para siguientes pasos
        echo "TAG=$TAG" >> $GITHUB_ENV
        echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
        echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV

    - name: ğŸš€ Deploy to Cloud Run
      run: |
        gcloud run deploy $SERVICE_NAME \
          --image gcr.io/${{ env.PROJECT_ID }}/${{ env.IMAGE_NAME }}:$TAG \
          --region ${{ env.REGION }} \
          --platform managed \
          --allow-unauthenticated \
          --port 8080 \
          --memory=512Mi \
          --cpu=1 \
          --max-instances=10 \
          --concurrency=80 \
          --timeout=300

    - name: ğŸ“¡ Show deployment info
      run: |
        echo "âœ… Deployment completed!"
        echo "ğŸŒ URL: https://$SERVICE_NAME-${{ env.PROJECT_ID }}-${{ env.REGION }}.a.run.app"
        echo "ğŸ·ï¸ Image tag: $TAG"
        echo "ğŸ”§ Environment: $ENVIRONMENT"

